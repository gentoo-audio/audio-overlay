version: 2.1

jobs:
  check new versions:
    machine: true
    resource_class: large
    steps:
      - checkout
      - run: ./tests/newversioncheck.sh

  pkgcheck all:
    docker:
      - image: registry.gitlab.fem-net.de/gentoo/fem-overlay-ci-image:master
    resource_class: small
    steps:
      - checkout
      - run: pkgcheck scan

  pkgcheck changes:
    docker:
      - image: registry.gitlab.fem-net.de/gentoo/fem-overlay-ci-image:master
    resource_class: small
    steps:
      - checkout
      - run: |
          git fetch
          pkgcheck scan --commits origin/master..HEAD

  manifest all:
    docker:
      - image: registry.gitlab.fem-net.de/gentoo/fem-overlay-ci-image:master
    resource_class: small
    steps:
      - checkout
      - run: MANIFEST_ONLY_DIFF=false /tools/manifest_packages.sh

  manifest changes:
    docker:
      - image: registry.gitlab.fem-net.de/gentoo/fem-overlay-ci-image:master
    resource_class: small
    steps:
      - checkout
      - run: MANIFEST_ONLY_DIFF=true /tools/manifest_packages.sh

  emerge new or changed ebuilds:
    machine: true
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: portage-pkgdir-emerge
      - run: ./tests/emerge-new-or-changed-ebuilds.sh
      - save_cache:
          key: portage-pkgdir-emerge-{{ epoch }}
          paths:
            - ~/.portage-pkgdir

  generate site:
    machine: true
    steps:
      - checkout
      - run: ./docs/generate-site.sh
      - persist_to_workspace:
          root: docs/site
          paths:
            - index.md
  deploy site:
    machine: true
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/docs
      - run: .circleci/deploy-gh-pages.sh


workflows:
  version: 2
  daily tests:
    triggers:
     - schedule:
         cron: "0 16 * * *"
         filters:
           branches:
             only:
               - master

    jobs:
      - check new versions
      - pkgcheck all

  weekly tests:
    triggers:
      - schedule:
          cron: "0 9 * * 1"
          filters:
            branches:
              only:
                - master
    jobs:
      - manifest all

  pullrequest:
    jobs:
      - pkgcheck changes:
          filters:
            branches:
              ignore: master
      - manifest changes:
          filters:
            branches:
              ignore: master
      - emerge new or changed ebuilds:
          requires:
            - pkgcheck changes
          filters:
            branches:
              ignore: master

  update site:
    jobs:
      - generate site:
          filters:
            branches:
              only:
                - master

      - deploy site:
          requires:
            - generate site
          filters:
            branches:
              only:
                - master
